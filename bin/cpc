#!/bin/sh
ROOT=`dirname $0`
# Assume cpc.asm.exe is in the same directory.
CPC=$ROOT/cpc.asm.exe
# The -I and -L flags are hacks to make this script work even if cpc has
# not been installed system-wide.
LOCAL_INC=-I$ROOT/../include
LOCAL_LIB=-L$ROOT/../runtime

set -e

defobject=a.out

while getopts cgOto: f; do
    case $f in
        c) nolink=-c; unset defobject;;
        g) debug=-g; cildebug="--debug debug";;
        O) optimise=-O3;;
        t) tail=-t; taildef=-DCPC_TAIL_RECURSIVE_COMPILER;;
        o) object="$OPTARG";;
    esac
done

shift $(($OPTIND - 1))

if [ $# -ne 1 ]; then
    echo 'Syntax: cpc [flags] source' >&2
    exit 1
fi

source="$1"

defobject="${defobject:-"${source%.cpc}.o"}"
object=${object:-"$defobject"}

gcc -E $LOCAL_INC -include cpc/cpc_runtime.h -Wall \
  $taildef - <"$source" >"$source.i"
$CPC "$source.i" $cildebug --out "$source.i.c"
gcc -Wall $nolink $debug $optimise $taildef $LOCAL_LIB -lm -pthread -o "$object" \
  "$source.i.c" -lcpcfull
