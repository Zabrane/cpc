#!/bin/sh

CPC=`dirname $0`/cpc.asm.exe

set -e

defobject=a.out

while getopts cgOto: f; do
    case $f in
        c) nolink=-c; unset defobject;;
        g) debug=-g; cildebug="--debug debug";;
        O) optimise=-O3;;
        t) tail=-t; taildef=-DCPC_TAIL_RECURSIVE_COMPILER;;
        o) object="$OPTARG";;
    esac
done

shift $(($OPTIND - 1))

if [ $# -ne 1 ]; then
    echo 'Syntax: cpc [flags] source' >&2
    exit 1
fi

source="$1"

defobject="${defobject:-"${source%.cpc}.o"}"
object=${object:-"$defobject"}

gcc -E -I`dirname $0`/../include -I cpc -include cpc_runtime.h -Wall \
  $taildef - <"$source" >"$source.i"
$CPC "$source.i" $cildebug --out "$source.i.c"
gcc -Wall $nolink $debug $optimise $taildef -L`dirname $0`/../runtime -lm -pthread -o "$object" \
  "$source.i.c" -lcpcfull
