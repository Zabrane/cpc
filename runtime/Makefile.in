CPC='../bin/cpc.asm.exe'

CDEBUGFLAGS=-Wall -g -O2
CLIBS=-I ../include/cpc
CFLAGS=$(CDEBUGFLAGS) $(CLIBS) $(EXTRA_DEFINES)

RANLIB=@RANLIB@

LDLIBS=-pthread

PREFIX=/usr/local

.SUFFIXES: .cpc .cpi

.PHONY: all clean

all: libcpc.a libcpcfull.a

cpc_runtime.o: cpc_runtime.c
	$(CC) $(CFLAGS) -c $<

threadpool/threadpool.o: threadpool/threadpool.c
	cd threadpool && $(MAKE) threadpool.o

libcpc.a: cpc_runtime.o threadpool/threadpool.o
	rm -f $@
	$(AR) rc $@ $^
	$(RANLIB) $@

libcpcfull.a: cpc_runtime.o threadpool/threadpool.o cpc_barrier.o cpc_io.o
	rm -f $@
	$(AR) rc $@ $^
	$(RANLIB) $@

clean:
	rm -f *~
	rm -f cpc_runtime.o threadpool/threadpool.o
	rm -f libcpc.a libcpcfull.a
	rm -f cpc_barrier.o cpc_io.o
	rm -f cpc_barrier.cpi cpc_io.cpi
	rm -f cpc_barrier.c cpc_io.c

.cpc.cpi:
	$(CC) -E -x c $(CFLAGS) -include cpc_runtime.h \
	  -o $@ $<

.cpi.c:
	$(CPC) $< --out $@

